nextflow_process {

    name "Test Process UPP_ALIGN"
    script "../main.nf"
    process "UPP_ALIGN"
    config "./nextflow.config"

    tag "modules"
    tag "modules_nfcore"
    tag "upp"
    tag "upp/align"
    tag "famsa"
    tag "famsa/guidetree"
    tag "famsa/align"

    test("fasta - align_sequence - uncompressed") {
        when {
            process {
                """
                    input[0] = [
                        [ id:'test' ],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/multiplesequencealign/testdata/setoxin-ref.fa", checkIfExists: true),
                        []
                    ]
                    input[1] = [[:],[]]
                    input[2] = false
                    """
            }
        }

        then {
            assertAll(
                    { assert process.success },
                    { assert snapshot(sanitizeOutput(process.out)).match() }
                    )
        }
    }

    test("fasta - with_tree - compressed") {
        setup {
            run("FAMSA_GUIDETREE") {
                script "../../../famsa/guidetree/main.nf"
                process {
                    """
                    input[0] = [
                        [ id:'tree' ],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/multiplesequencealign/testdata/setoxin-ref.fa", checkIfExists: true)
                    ]
                    """
                }
            }
            run("FAMSA_ALIGN") {
                script "../../../famsa/align/main.nf"
                process {
                    """
                    input[0] = [
                        [ id:'align_tree' ],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/multiplesequencealign/testdata/setoxin-ref.fa", checkIfExists: true)
                    ]
                    input[1] = [[],[]]  // no tree needed for reference alignment
                    input[2] = false
                    """
                }
            }
        }
        when {
            process {
                """
                    input[0] = channel.of([
                        [ id:'test_tree' ],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/multiplesequencealign/testdata/toxin-ref.fa", checkIfExists: true)
                    ]).combine(
                        FAMSA_ALIGN.out.alignment.map{ meta, file -> [file]}
                    )
                    input[1] = FAMSA_GUIDETREE.out.tree
                    input[2] = true
                    """
            }
        }

        then {
            assertAll(
                    { assert process.success },
                    { assert snapshot(
                        file(process.out.alignment[0][1]).name, // Unstable
                        process.out.findAll { key, val -> key.startsWith("versions")}
                    ).match()}
            )
        }
    }

    test("stub") {
        options "-stub"
        when {
            process {
                """
                    input[0] = [
                        [ id:'test' ],
                        file("https://raw.githubusercontent.com/nf-core/test-datasets/multiplesequencealign/testdata/setoxin-ref.fa", checkIfExists: true),
                        []
                    ]
                    input[1] = [[:],[]]
                    input[2] = false
                    """
            }
        }

        then {
            assertAll(
                    { assert process.success },
                    { assert snapshot(sanitizeOutput(process.out)).match()}
                    )
        }
    }
}
